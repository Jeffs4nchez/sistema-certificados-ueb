═══════════════════════════════════════════════════════════════════════════════
MANEJO INTELIGENTE DE DUPLICADOS EN IMPORTACIÓN CSV - LÓGICA SIMPLIFICADA
═══════════════════════════════════════════════════════════════════════════════

PROBLEMA RESUELTO:
─────────────────
Cuando se sube un CSV con el mismo contenido que uno anterior, el sistema 
ahora compara SOLO COL3 (Codificado):
  1. Si COL3 es IGUAL → IGNORA (sin duplicar)
  2. Si COL3 CAMBIÓ → ACTUALIZA y RECALCULA saldo
  3. Si es nuevo → INSERTA


REGLA SIMPLE:
─────────────

    ¿Código existe?
        ↓
    NO → INSERTAR nuevo ✓
        ↓
    SÍ → ¿COL3 cambió?
        ↓
        NO → IGNORAR (sin actualizar) ✓
        ↓
        SÍ → ACTUALIZAR y RECALCULAR saldo ✓


CAMPOS IGNORADOS:
─────────────────

Los siguientes campos se IGNORAN al detectar cambios:
  ✗ descripciong1 (Programa)
  ✗ descripciong2 (Actividad)
  ✗ descripciong3 (Fuente)
  ✗ descripciong4 (Geográfico)
  ✗ descripciong5 (Item)
  ✗ col1 (otro monto)
  ✗ codigog1-5 (códigos)

⚠️ SOLO SE CONSIDERA:
  ✓ COL3 (Codificado) - El monto presupuestario principal


EJEMPLO PRÁCTICO:
────────────────

PRIMER UPLOAD (15-Nov-2025):
┌────────────────────────────────────────────┐
│ PROGRAMA: Educación                        │
│ CODIGOG1: 01                               │
│ COL3: 100,000  ← VALOR CRÍTICO             │
│ COL4: 50,000                               │
└────────────────────────────────────────────┘
        ↓
    Se crea registro ID #1
    saldo_disponible = 100,000 - 50,000 = 50,000
    Estado: NUEVO ✓


SEGUNDO UPLOAD (20-Nov-2025) - COL3 IGUAL:
┌────────────────────────────────────────────┐
│ PROGRAMA: Educación  ← Cambió (ignorado)   │
│ CODIGOG1: 01                               │
│ COL3: 100,000  ← IGUAL                     │
│ COL4: 50,000                               │
└────────────────────────────────────────────┘
        ↓
    Sistema detecta: ID #1 ya existe
    Compara COL3: 100,000 = 100,000 ✓
    Acción: IGNORAR (sin cambios)
    Resultado: +1 DUPLICADO IGNORADO ✓
    BD SIGUE IGUAL: saldo = 50,000


TERCER UPLOAD (22-Nov-2025) - COL3 CAMBIÓ:
┌────────────────────────────────────────────┐
│ PROGRAMA: Educación                        │
│ CODIGOG1: 01                               │
│ COL3: 120,000  ← CAMBIÓ (se actualiza)     │
│ COL4: 50,000                               │
└────────────────────────────────────────────┘
        ↓
    Sistema detecta: ID #1 ya existe
    Compara COL3: 120,000 ≠ 100,000 ✗
    Acción: ACTUALIZAR
    Recálculo: saldo = 120,000 - 50,000 = 70,000
    Resultado: +1 ACTUALIZADO ✓
    BD CAMBIA: saldo = 70,000 (se recalcula automáticamente)


RESULTADOS REPORTADOS:
─────────────────────

Después del tercer upload:

    ✓ Importación completada:
      • 0 nuevo(s) registro(s) importado(s)
      • 1 registro(s) actualizado(s) (col3 cambió)
      • 2 registro(s) ignorado(s) (col3 sin cambios)
      • 0 errores


IMPLEMENTACIÓN TÉCNICA:
──────────────────────

CAMBIOS EN: app/models/PresupuestoItem.php

generarHashItem($data) - SIMPLIFICADO
  → Ahora SOLO genera hash de COL3
  → return md5($data['col3']);

importCSV($filePath) - LÓGICA SIMPLIFICADA
  → Para cada línea:
    a) Busca por código completo
    b) Si existe:
       - Compara: col3Nuevo vs col3Actual
       - Si diferentes: updated++
       - Si iguales: duplicated++
    c) Si no existe: imported++


CÁLCULO DE SALDO:
─────────────────

La fórmula es simple:
    saldo_disponible = col3 - col4
    
Ejemplo:
    • COL3: 100,000 (Codificado)
    • COL4: 50,000  (Certificado)
    • SALDO: 50,000 (Disponible para certificar)

Si COL3 cambia a 120,000:
    • NUEVO SALDO: 70,000 (automático)


VENTAJAS:
─────────

✓ Lógica simple: SOLO COL3 importa
✓ No genera duplicados idénticos
✓ Permite actualizar presupuestos cuando cambia COL3
✓ Mantiene la integridad de datos
✓ Saldo se recalcula automáticamente
✓ Reporta claramente qué pasó


CASOS DE USO:
─────────────

1. IMPORTACIÓN INICIAL:
   Se sube presupuesto_base.csv
   → 150 registros nuevos

2. RESUBIR MISMO CSV (SIN CAMBIOS):
   Se sube presupuesto_base.csv nuevamente
   → 150 duplicados ignorados (COL3 sin cambios)

3. ACTUALIZAR COL3:
   Se sube presupuesto_v2.csv (COL3 actualizado)
   → 150 registros actualizados (COL3 cambió)

4. CAMBIOS IRRELEVANTES:
   Se sube presupuesto.csv (solo cambió descripción)
   → 150 duplicados ignorados (COL3 sigue igual)


TESTING:
────────

Test 1: CSV duplicado exacto
  1. Sube presupuesto.csv (COL3: 100 en 5 líneas)
  2. Resultado: 5 importados ✓
  3. Sube MISMO presupuesto.csv
  4. Resultado: 0 nuevos, 0 actualizados, 5 duplicados ✓
  5. BD SIGUE IGUAL: 5 registros

Test 2: CSV con COL3 actualizado
  1. Sube presupuesto.csv (COL3: 100)
  2. Resultado: 5 importados ✓
  3. Sube presupuesto_v2.csv (COL3: 120)
  4. Resultado: 0 nuevos, 5 actualizados, 0 duplicados ✓
  5. BD CAMBIA: saltos recalculados a -20 menos

Test 3: Cambios en otros campos (ignorados)
  1. Sube presupuesto.csv (descrip: "Educación")
  2. Resultado: 5 importados ✓
  3. Sube presupuesto_v2.csv (descrip: "Programa de Educación", COL3: igual)
  4. Resultado: 0 nuevos, 0 actualizados, 5 duplicados ✓
  5. BD SIGUE IGUAL: descripción antigua se mantiene


RESUMEN:
────────

┌─────────────────────────────┬──────────┬───────────┐
│ Escenario                   │ Acción   │ Resultado │
├─────────────────────────────┼──────────┼───────────┤
│ CSV nuevo                   │ INSERT   │ Nuevo     │
│ CSV idéntico (COL3 igual)   │ IGNORE   │ Duplicado │
│ CSV con COL3 diferente      │ UPDATE   │ Actualiz. │
│ CSV solo descripción distinta│ IGNORE   │ Duplicado │
└─────────────────────────────┴──────────┴───────────┘


VERSIÓN:
────────
v1.3 - Diciembre 2025
Lógica simplificada: SOLO COL3 determina si hay cambios

═══════════════════════════════════════════════════════════════════════════════
