================================================================================
VALIDACIÓN OBLIGATORIA DE MEMORANDO EN LIQUIDACIONES
================================================================================

FECHA: 6 de Enero de 2026
VERSIÓN: 1.0

================================================================================
CAMBIOS REALIZADOS:
================================================================================

ARCHIVO: app/views/certificate/list.php

✓ Agregada validación de Memorando/Comprobante obligatorio
✓ Se valida que si hay un monto en liquidación, el comprobante es OBLIGATORIO
✓ Validación en tiempo real mientras el usuario escribe
✓ Validación al guardar (lado del servidor también validará)

================================================================================
COMPORTAMIENTO:
================================================================================

1. VALIDACIÓN EN TIEMPO REAL:
   
   Al escribir en el campo de "Liquidación":
   - Si ingresa un monto > 0 → El campo "Memorando" se marca como obligatorio
   - Si borra el monto → El campo "Memorando" vuelve a ser opcional
   
   Al escribir en el campo de "Memorando":
   - Si hay liquidación (monto > 0) y el campo está vacío → Campo en rojo
   - Si escribes algo → Se quita el color rojo
   - Si el campo tiene contenido → Se acepta

2. VALIDACIÓN AL GUARDAR:
   
   Al hacer clic en "Guardar Liquidaciones":
   - Sistema valida que TODOS los items con liquidación tengan memorando
   - Si falta memorando en algún item → Muestra error:
     "❌ Por favor completa los siguientes campos:
      Item 101: El Memorando/Comprobante es obligatorio cuando hay liquidación"
   - Si todo está correcto → Guarda las liquidaciones

================================================================================
EJEMPLOS DE USO:
================================================================================

ESCENARIO 1: Liquidación sin comprobante
└─> Ingresa monto: $ 50.00
└─> No ingresa comprobante
└─> Intenta guardar
└─> Sistema muestra error rojo
└─> Error: "Item 100: El Memorando/Comprobante es obligatorio cuando hay liquidación"

ESCENARIO 2: Liquidación con comprobante
└─> Ingresa monto: $ 50.00
└─> Ingresa comprobante: "Factura #2024-0001"
└─> Intenta guardar
└─> ✓ Se guarda exitosamente

ESCENARIO 3: Sin liquidación (opcional el comprobante)
└─> Deja monto en 0 (o vacío)
└─> No ingresa comprobante
└─> Intenta guardar
└─> ✓ Se permite guardar sin comprobante

================================================================================
VALIDACIONES IMPLEMENTADAS:
================================================================================

1. FUNCIÓN: validarLiquidacion(input)
   - Se ejecuta cuando el usuario cambia el monto de liquidación
   - Valida que no exceda cantidad pendiente
   - Si hay monto > 0, llama a validarMemorandoObligatorio()

2. FUNCIÓN: validarMemorandoObligatorio(memorandoInput)
   - Se ejecuta cuando el usuario escribe en el campo de memorando
   - Verifica si hay monto de liquidación en la misma fila
   - Si hay monto Y el memorando está vacío → Marca con is-invalid (rojo)
   - Si hay monto Y hay memorando → Quita marca is-invalid

3. FUNCIÓN: mostrarAlerta(input)
   - Se ejecuta mientras el usuario escribe el monto
   - Valida cantidad no exceda pendiente
   - Si hay monto, llama a validarMemorandoObligatorio()

4. EVENTO: Guardar Liquidaciones
   - Valida que todos los items con liquidación tengan memorando
   - Si falta: Marca el campo en rojo y muestra lista de errores
   - Si todo OK: Procede al guardado

================================================================================
INDICADORES VISUALES:
================================================================================

Campo Obligatorio (cuando hay liquidación):
- Borde rojo en el campo de Memorando
- Clase CSS: is-invalid
- Mensaje de error debajo (opcional)

Campo Opcional (sin liquidación):
- Sin marca visual
- Se puede dejar vacío

================================================================================
FLUJO TÉCNICO:
================================================================================

1. Usuario escribe monto: $ 100
   └─> Evento: oninput="mostrarAlerta(this)"
   └─> validarLiquidacion() comprueba monto < pendiente
   └─> Si monto > 0 → validarMemorandoObligatorio(memorando)
   └─> Si memorando vacío → Agregar clase is-invalid (rojo)

2. Usuario escribe comprobante: "Factura #001"
   └─> Evento: oninput="validarMemorandoObligatorio(this)"
   └─> Verifica si hay monto > 0 en la fila
   └─> Si hay monto Y hay texto → Quitar clase is-invalid
   └─> Campo se ve normal (sin rojo)

3. Usuario hace clic "Guardar Liquidaciones"
   └─> JavaScript recorre todos los items
   └─> Para cada item con cantidad > 0:
   └─> Valida que memorando.value.trim() no esté vacío
   └─> Si está vacío → Agrega error a lista de validación
   └─> Si hay errores → Muestra alerta y retorna
   └─> Si no hay errores → Envía datos al servidor (POST)

================================================================================
ARCHIVOS MODIFICADOS:
================================================================================

1. app/views/certificate/list.php
   
   Cambios:
   a) Línea ~312: Agregado evento oninput="validarMemorandoObligatorio(this)"
                  Agregado elemento <small> con clase validacion-error-memorando
   
   b) Línea ~380-420: Modificada función validarLiquidacion()
                      Agregada lógica de validación de memorando obligatorio
   
   c) Línea ~422-440: Agregada función validarMemorandoObligatorio(memorandoInput)
   
   d) Línea ~442-480: Modificada función mostrarAlerta()
                      Agregada validación de memorando en tiempo real
   
   e) Línea ~390-450: Modificada validación al guardar liquidaciones
                      Agregada validación de memorando obligatorio
                      Agregada lista de errores personalizados

================================================================================
MENSAJES DE ERROR:
================================================================================

VALIDACIÓN EN TIEMPO REAL:
- Campo con borde rojo (is-invalid)
- Mensaje bajo el campo: "Obligatorio si hay liquidación" (opcional)

VALIDACIÓN AL GUARDAR:
"❌ Por favor completa los siguientes campos:

Item 100: El Memorando/Comprobante es obligatorio cuando hay liquidación
Item 101: El Memorando/Comprobante es obligatorio cuando hay liquidación"

OTROS ERRORES:
- "Error: Hay liquidaciones que exceden el saldo pendiente"
- "⚠️ No hay liquidaciones para guardar"

================================================================================
TESTING:
================================================================================

CASO 1: Ingresa liquidación sin comprobante
1. Abre modal de liquidación
2. En el campo "Liquidación" escribe: 50
3. Deja en blanco el campo "Memorando"
4. Hace clic en "Guardar Liquidaciones"
5. ✓ Se muestra error: "El Memorando/Comprobante es obligatorio"
6. ✓ El campo Memorando se marca en rojo

CASO 2: Ingresa liquidación CON comprobante
1. Abre modal de liquidación
2. En el campo "Liquidación" escribe: 50
3. En el campo "Memorando" escribe: "Factura #2024-001"
4. Hace clic en "Guardar Liquidaciones"
5. ✓ Se guarda correctamente
6. ✓ Se recarga la página mostrando liquidación guardada

CASO 3: Sin liquidación (comprobante opcional)
1. Abre modal de liquidación
2. Deja el campo "Liquidación" en blanco (o 0)
3. Deja el campo "Memorando" vacío
4. Hace clic en "Guardar Liquidaciones"
5. ✓ Se muestra: "⚠️ No hay liquidaciones para guardar"
6. ✓ Ningún item se marca en rojo

CASO 4: Validación en tiempo real
1. Abre modal de liquidación
2. En "Liquidación" escribe: 50
3. ✓ Campo "Memorando" se pone rojo automáticamente
4. Escribe en "Memorando": "Comprobante"
5. ✓ Campo "Memorando" se vuelve normal (sin rojo)
6. Borra el monto: 0
7. ✓ Campo "Memorando" se vuelve normal (opcional)

================================================================================
COMPATIBILIDAD:
================================================================================

✓ Todos los navegadores modernos
✓ Validación con Bootstrap (clase is-invalid)
✓ Compatible con mobile
✓ Fallback: Si JavaScript falla, el servidor también valida

================================================================================
PRÓXIMAS MEJORAS (OPCIONAL):
================================================================================

1. Autocompletado de comprobantes previos
2. Validación de formato de comprobante
3. Lista de tipos de comprobante (dropdown)
4. Historial de comprobantes usados
5. Campo de nota adicional
6. Adjuntar archivo de comprobante (foto/PDF)

================================================================================
