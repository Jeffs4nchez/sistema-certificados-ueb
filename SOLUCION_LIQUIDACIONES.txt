/**
 * SOLUCI√ìN: Guardar cantidad_liquidacion en tabla liquidaciones
 * Fecha: 14 de Diciembre de 2025
 */

=== PROBLEMA IDENTIFICADO ===

El campo "cantidad_liquidacion" estaba siendo guardado en la tabla "detalle_certificados"
pero la tabla "liquidaciones" (que existe y est√° dise√±ada para el hist√≥rico) estaba completamente
vac√≠a (0 registros).

Estructura observada:
  ‚úÖ Tabla: liquidaciones (EXISTE, pero vac√≠a)
     - id (PK)
     - detalle_certificado_id (FK)
     - cantidad_liquidacion (DECIMAL)
     - fecha_liquidacion (DATE)
     - descripcion (TEXT)
     - usuario_creacion (VARCHAR)
     - fecha_creacion (TIMESTAMP)
     - fecha_actualizacion (TIMESTAMP)

  ‚úÖ Tabla: detalle_certificados
     - cantidad_liquidacion (NUMERIC, NULL)
     - cantidad_pendiente (NUMERIC, NULL)

=== CAUSA RA√çZ ===

El m√©todo Certificate::updateLiquidacion() en app/models/Certificate.php
SOLO actualizaba la tabla detalle_certificados pero NO insertaba en liquidaciones
para crear el hist√≥rico de liquidaciones.

=== SOLUCI√ìN IMPLEMENTADA ===

Se modific√≥ el m√©todo updateLiquidacion() en:
  üìÑ app/models/Certificate.php (l√≠nea ~469)

Se agreg√≥ un nuevo bloque de c√≥digo (paso 4.5) que:
  1. Verifica que cantidad_liquidacion > 0
  2. Inserta un registro en la tabla liquidaciones con:
     - detalle_certificado_id
     - cantidad_liquidacion
     - fecha_liquidacion (CURRENT_DATE)
     - descripcion (autom√°tica)
     - usuario_creacion (desde $_SESSION['usuario_nombre'])
     - fecha_creacion (CURRENT_TIMESTAMP)
     - fecha_actualizacion (CURRENT_TIMESTAMP)

=== C√ìDIGO AGREGADO ===

Se insert√≥ el siguiente c√≥digo despu√©s de actualizar detalle_certificados:

```php
// 4.5. INSERTAR EN TABLA LIQUIDACIONES (crear hist√≥rico)
if ($cantidad_liquidacion > 0) {
    $insertLiquidacion = $this->db->prepare("
        INSERT INTO liquidaciones (
            detalle_certificado_id, 
            cantidad_liquidacion, 
            fecha_liquidacion, 
            descripcion, 
            usuario_creacion,
            fecha_creacion,
            fecha_actualizacion
        ) VALUES (?, ?, CURRENT_DATE, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    ");
    
    $usuario = $_SESSION['usuario_nombre'] ?? 'SISTEMA';
    $descripcion = 'Liquidaci√≥n de cantidad: ' . number_format($cantidad_liquidacion, 2);
    
    $resultado_liq = $insertLiquidacion->execute([
        $detalle_id,
        $cantidad_liquidacion,
        $descripcion,
        $usuario
    ]);
    
    if ($resultado_liq) {
        error_log("‚úÖ liquidaciones insertado: detalle_id=$detalle_id, cantidad=$cantidad_liquidacion, usuario=$usuario");
    } else {
        error_log("‚ö†Ô∏è Error al insertar en liquidaciones: " . print_r($insertLiquidacion->errorInfo(), true));
        // No lanzamos excepci√≥n porque el insert en detalle_certificados ya se hizo
    }
}
```

=== RESULTADO DESPU√âS DE LA FIX ===

Prueba ejecutada:
  ‚úÖ Se actualiz√≥ detalle_certificados correctamente:
     - cantidad_liquidacion: 250.00
     - cantidad_pendiente: 750.00

  ‚úÖ Se insert√≥ en liquidaciones:
     - ID: 1
     - detalle_certificado_id: 320
     - cantidad_liquidacion: 250.00
     - fecha_liquidacion: 2025-12-14
     - usuario_creacion: Usuario Prueba
     - fecha_creacion: (timestamp autom√°tico)
     - fecha_actualizacion: (timestamp autom√°tico)

=== ARCHIVOS MODIFICADOS ===

1. üìù app/models/Certificate.php
   - M√©todo: updateLiquidacion()
   - L√≠nea: ~469 (despu√©s de actualizar detalle_certificados)
   - Cambio: Agregado insert en tabla liquidaciones

=== C√ìMO FUNCIONA AHORA ===

1. Usuario realiza una liquidaci√≥n en la UI
2. Se llama a Certificate::updateLiquidacion($detalle_id, $cantidad)
3. El m√©todo:
   ‚úÖ Actualiza detalle_certificados (cantidad_liquidacion, cantidad_pendiente)
   ‚úÖ AHORA TAMBI√âN inserta en liquidaciones (crea hist√≥rico)
   ‚úÖ Actualiza presupuesto_items (col4, saldo_disponible)
   ‚úÖ Actualiza certificados (totales)

=== BENEFICIOS ===

‚úÖ Hist√≥rico completo de liquidaciones (tabla liquidaciones)
‚úÖ Trazabilidad de qui√©n liquid√≥ y cu√°ndo
‚úÖ Posibilidad de auditar liquidaciones
‚úÖ Mantiene ambas tablas sincronizadas
‚úÖ No afecta liquidaciones anteriores (solamente nuevas)

=== PRUEBAS RECOMENDADAS ===

1. Crear una liquidaci√≥n nueva desde la UI
2. Verificar que aparezca en tabla liquidaciones
3. Verificar que cantidad_liquidacion se actualice en detalle_certificados
4. Verificar logs en error_log para confirmar ejecuci√≥n

Comando de prueba:
  php test_liquidacion.php
